# 悦聊用户管理接口文档

## 部署说明

### 1. 安装依赖

代码拉到服务器后，需要安装新增的 Python 依赖：

```bash
pip install motor
```

或者使用 requirements.txt（如果有的话）：

```bash
pip install -r requirements.txt
```

### 2. 环境配置

确保 `.env` 文件中配置了 MongoDB 连接：

```bash
# MongoDB配置（与悦聊服务共享同一个数据库）
MONGODB_URI=mongodb://127.0.0.1:27017/yueliao
```

如果 MongoDB 在远程服务器或有认证：

```bash
MONGODB_URI=mongodb://username:password@host:port/yueliao
```

### 3. 重启服务

```bash
# 重启 Python 后端服务
python biz/application.py
# 或使用 uvicorn
uvicorn biz.application:app --host 0.0.0.0 --port 3003
```

---

## API 接口文档

### 基础信息

- **Base URL**: `http://your-server:3003`
- **认证方式**: JWT Bearer Token（与其他管理后台接口一致）
- **请求头**:
  ```
  Authorization: Bearer <your_jwt_token>
  ```

---

## 接口列表

### 1. 获取用户列表

**接口地址**: `GET /api/admin/yueliao-users/list`

**请求参数**:

| 参数名    | 类型   | 必填 | 说明                                   | 示例值    |
| --------- | ------ | ---- | -------------------------------------- | --------- |
| page      | int    | 否   | 页码，默认 1                           | 1         |
| page_size | int    | 否   | 每页数量，默认 20，最大 100            | 20        |
| search    | string | 否   | 搜索关键词（支持昵称/手机号/悦聊 ID） | 张三      |

**请求示例**:

```bash
GET /api/admin/yueliao-users/list?page=1&page_size=20&search=张三
```

**响应示例**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "users": [
      {
        "id": "6731f85a8322e080eeab2b95",
        "yueliaoId": "12345678",
        "phone": "13800138000",
        "nickname": "张三",
        "avatar": "/static/avatars/avatar-042.png",
        "status": "online",
        "lastSeen": "2025-11-19T08:30:00.000Z",
        "friends": ["6731f85a8322e080eeab2b96"],
        "qrCode": "data:image/png;base64,iVBORw0KG...",
        "createdAt": "2025-11-10T10:20:30.000Z",
        "updatedAt": "2025-11-19T08:30:00.000Z"
      }
    ],
    "total": 150,
    "page": 1,
    "page_size": 20,
    "total_pages": 8
  }
}
```

**字段说明**:

| 字段名     | 类型   | 说明                              |
| ---------- | ------ | --------------------------------- |
| id         | string | 用户唯一 ID（MongoDB ObjectId）   |
| yueliaoId  | string | 8 位悦聊 ID                       |
| phone      | string | 手机号                            |
| nickname   | string | 用户昵称                          |
| avatar     | string | 头像 URL                          |
| status     | string | 在线状态：online/offline/busy     |
| lastSeen   | string | 最后在线时间（ISO 8601 格式）     |
| friends    | array  | 好友 ID 列表                      |
| qrCode     | string | 用户二维码（base64 格式）         |
| createdAt  | string | 账号创建时间                      |
| updatedAt  | string | 最后更新时间                      |

---

### 2. 获取用户详情

**接口地址**: `GET /api/admin/yueliao-users/detail/{user_id}`

**路径参数**:

| 参数名  | 类型   | 必填 | 说明            | 示例值                   |
| ------- | ------ | ---- | --------------- | ------------------------ |
| user_id | string | 是   | 用户 ID         | 6731f85a8322e080eeab2b95 |

**请求示例**:

```bash
GET /api/admin/yueliao-users/detail/6731f85a8322e080eeab2b95
```

**响应示例**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "6731f85a8322e080eeab2b95",
    "yueliaoId": "12345678",
    "phone": "13800138000",
    "nickname": "张三",
    "avatar": "/static/avatars/avatar-042.png",
    "status": "online",
    "lastSeen": "2025-11-19T08:30:00.000Z",
    "friends": ["6731f85a8322e080eeab2b96", "6731f85a8322e080eeab2b97"],
    "friendRequests": [
      {
        "id": "req_001",
        "from": "6731f85a8322e080eeab2b98",
        "message": "我想加您为好友",
        "status": "pending",
        "createdAt": "2025-11-18T10:00:00.000Z"
      }
    ],
    "qrCode": "data:image/png;base64,iVBORw0KG...",
    "settings": {
      "language": "zh-cn",
      "theme": "auto",
      "notifications": {
        "messageSound": true,
        "vibrate": true,
        "showPreview": true
      }
    },
    "createdAt": "2025-11-10T10:20:30.000Z",
    "updatedAt": "2025-11-19T08:30:00.000Z"
  }
}
```

**错误响应**:

```json
{
  "code": 404,
  "message": "用户不存在",
  "data": {}
}
```

---

### 3. 通过手机号搜索用户

**接口地址**: `GET /api/admin/yueliao-users/search/phone`

**请求参数**:

| 参数名 | 类型   | 必填 | 说明   | 示例值      |
| ------ | ------ | ---- | ------ | ----------- |
| phone  | string | 是   | 手机号 | 13800138000 |

**请求示例**:

```bash
GET /api/admin/yueliao-users/search/phone?phone=13800138000
```

**响应示例**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "6731f85a8322e080eeab2b95",
    "yueliaoId": "12345678",
    "phone": "13800138000",
    "nickname": "张三",
    "avatar": "/static/avatars/avatar-042.png",
    "status": "online",
    "lastSeen": "2025-11-19T08:30:00.000Z",
    "friends": ["6731f85a8322e080eeab2b96"],
    "qrCode": "data:image/png;base64,iVBORw0KG...",
    "createdAt": "2025-11-10T10:20:30.000Z",
    "updatedAt": "2025-11-19T08:30:00.000Z"
  }
}
```

**错误响应**:

```json
{
  "code": 404,
  "message": "用户不存在",
  "data": {}
}
```

---

### 4. 通过悦聊 ID 搜索用户

**接口地址**: `GET /api/admin/yueliao-users/search/yueliao-id`

**请求参数**:

| 参数名     | 类型   | 必填 | 说明        | 示例值   |
| ---------- | ------ | ---- | ----------- | -------- |
| yueliao_id | string | 是   | 8 位悦聊 ID | 12345678 |

**请求示例**:

```bash
GET /api/admin/yueliao-users/search/yueliao-id?yueliao_id=12345678
```

**响应示例**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "6731f85a8322e080eeab2b95",
    "yueliaoId": "12345678",
    "phone": "13800138000",
    "nickname": "张三",
    "avatar": "/static/avatars/avatar-042.png",
    "status": "online",
    "lastSeen": "2025-11-19T08:30:00.000Z",
    "friends": ["6731f85a8322e080eeab2b96"],
    "qrCode": "data:image/png;base64,iVBORw0KG...",
    "createdAt": "2025-11-10T10:20:30.000Z",
    "updatedAt": "2025-11-19T08:30:00.000Z"
  }
}
```

**错误响应**:

```json
{
  "code": 404,
  "message": "用户不存在",
  "data": {}
}
```

---

### 5. 获取用户统计数据

**接口地址**: `GET /api/admin/yueliao-users/statistics`

**请求参数**: 无

**请求示例**:

```bash
GET /api/admin/yueliao-users/statistics
```

**响应示例**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total_users": 1520
  }
}
```

---

## 错误码说明

| 错误码 | 说明               |
| ------ | ------------------ |
| 200    | 请求成功           |
| 400    | 请求参数错误       |
| 401    | 未授权（token 无效）|
| 404    | 资源不存在         |
| 500    | 服务器内部错误     |

---

## 注意事项

1. **所有接口都需要 JWT 认证**，请在请求头中携带有效的 token
2. **MongoDB 连接配置**：接口会连接到与悦聊服务相同的 MongoDB 数据库
3. **密码字段已过滤**：所有响应中都不会返回用户密码
4. **分页限制**：列表接口每页最多返回 100 条数据
5. **搜索功能**：支持模糊匹配（不区分大小写）

---

## 前端调用示例

### JavaScript/Axios

```javascript
// 获取用户列表
axios.get('/api/admin/yueliao-users/list', {
  params: {
    page: 1,
    page_size: 20,
    search: '张三'
  },
  headers: {
    'Authorization': `Bearer ${token}`
  }
})
.then(res => {
  console.log(res.data.data.users);
})

// 获取用户详情
axios.get(`/api/admin/yueliao-users/detail/${userId}`, {
  headers: {
    'Authorization': `Bearer ${token}`
  }
})
.then(res => {
  console.log(res.data.data);
})

// 手机号搜索
axios.get('/api/admin/yueliao-users/search/phone', {
  params: { phone: '13800138000' },
  headers: {
    'Authorization': `Bearer ${token}`
  }
})
.then(res => {
  console.log(res.data.data);
})
```

### TypeScript 类型定义

```typescript
interface YueliaoUser {
  id: string;
  yueliaoId: string;
  phone: string;
  nickname: string;
  avatar: string;
  status: 'online' | 'offline' | 'busy';
  lastSeen: string;
  friends: string[];
  qrCode?: string;
  createdAt: string;
  updatedAt: string;
}

interface UserListResponse {
  users: YueliaoUser[];
  total: number;
  page: number;
  page_size: number;
  total_pages: number;
}

interface UserStatistics {
  total_users: number;
}
```
