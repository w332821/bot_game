# Webhookæ¥å£è§„èŒƒæ–‡æ¡£

## æ ¸å¿ƒè¦æ±‚
**Appç«¯ä»£ç ä¸èƒ½æ”¹åŠ¨ï¼Œå¿…é¡»ä¿è¯å…¥å‚/å‡ºå‚æ ¼å¼100%å…¼å®¹Node.jsç‰ˆæœ¬**

---

## 1. POST /webhook

### è¯·æ±‚æ ¼å¼
```json
{
  "event": "message.received | group.created | member.joined",
  "data": {
    // æ ¹æ®eventç±»å‹ä¸åŒï¼Œdataç»“æ„ä¸åŒ
  }
}
```

### å“åº”æ ¼å¼
```json
{
  "status": "ok"
}
```

### é”™è¯¯å“åº”
```json
{
  "status": "error",
  "error": "é”™è¯¯ä¿¡æ¯"
}
```

---

## 2. äº‹ä»¶ç±»å‹è¯¦è§£

### 2.1 group.createdï¼ˆç¾¤èŠåˆ›å»ºï¼‰

**è¯·æ±‚æ•°æ®ç»“æ„**:
```json
{
  "event": "group.created",
  "data": {
    "chat": {
      "id": "chat_123",
      "name": "æµ‹è¯•ç¾¤"
    }
  }
}
```

**å¤„ç†é€»è¾‘**:
1. è°ƒç”¨æ‚¦èŠBot APIåŠ å…¥ç¾¤èŠ: `POST /api/bot/join/{chatId}`
2. åˆ›å»ºç¾¤èŠè®°å½•ï¼ˆåˆå§‹æ¸¸æˆç±»å‹: lucky8ï¼‰
3. å¯åŠ¨è‡ªåŠ¨å¼€å¥–å®šæ—¶å™¨
4. åŒæ­¥ç¾¤èŠæˆå‘˜
5. å‘é€æ¬¢è¿æ¶ˆæ¯

**æ¬¢è¿æ¶ˆæ¯å†…å®¹**:
```
ğŸ°ã€æ¾³æ´²å¹¸è¿8æ¸¸æˆæœºå™¨äººã€‘ğŸ°

æ¬¢è¿ä½¿ç”¨ï¼åˆå§‹ä½™é¢: 1000

ğŸ“‹ ç©æ³•è¯´æ˜:
â€¢ ç•ª: "ç•ª 3/200" æˆ– "3ç•ª200" (èµ”ç‡3å€)
â€¢ æ­£: "æ­£1/200" æˆ– "1/200" (èµ”ç‡2å€)
â€¢ å•åŒ: "å•200" æˆ– "åŒ150" (èµ”ç‡2å€)

ğŸ” æŸ¥è¯¢æŒ‡ä»¤:
â€¢ "æŸ¥" - æŸ¥è¯¢ä½™é¢
â€¢ "æ’è¡Œ" - æŸ¥çœ‹æ’è¡Œæ¦œ

â° æ¯5åˆ†é’Ÿè‡ªåŠ¨å¼€å¥–
ğŸ’° è¿™æ˜¯è™šæ‹Ÿè´§å¸æ¸¸æˆï¼Œä»…ä¾›å¨±ä¹ï¼
```

---

### 2.2 member.joinedï¼ˆæ–°æˆå‘˜åŠ å…¥ï¼‰

**è¯·æ±‚æ•°æ®ç»“æ„**:
```json
{
  "event": "member.joined",
  "data": {
    "chat": {
      "id": "chat_123"
    },
    "member": {
      "id": "user_456",
      "name": "å¼ ä¸‰"
    }
  }
}
```

**å¤„ç†é€»è¾‘**:
1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
2. å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·ï¼ˆåˆå§‹ä½™é¢: 1000ï¼‰

---

### 2.3 message.receivedï¼ˆæ¥æ”¶åˆ°æ¶ˆæ¯ï¼‰

**è¯·æ±‚æ•°æ®ç»“æ„**:
```json
{
  "event": "message.received",
  "data": {
    "message": {
      "content": "æŸ¥",
      "chat": {
        "id": "chat_123",
        "name": "æµ‹è¯•ç¾¤"
      },
      "sender": {
        "_id": "user_456",  // æˆ– "id"
        "id": "user_456",
        "name": "å¼ ä¸‰",
        "isBot": false
      }
    }
  }
}
```

**å¤„ç†é€»è¾‘**:

#### 1. å¿½ç•¥æœºå™¨äººæ¶ˆæ¯
```javascript
if (message.sender.isBot) {
  return { status: 'ok' };
}
```

#### 2. ç¡®ä¿ç¾¤èŠå­˜åœ¨
å¦‚æœç¾¤èŠä¸å­˜åœ¨ï¼Œåˆ›å»ºç¾¤èŠå¹¶å¯åŠ¨å®šæ—¶å™¨

#### 3. ç¡®ä¿ç”¨æˆ·å­˜åœ¨
å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºç”¨æˆ·ï¼ˆåˆå§‹ä½™é¢: 1000ï¼‰

#### 4. æ ¹æ®æ¶ˆæ¯å†…å®¹åˆ†å‘å¤„ç†

| æŒ‡ä»¤ | è§¦å‘æ¡ä»¶ | å¤„ç†å‡½æ•° |
|------|---------|---------|
| æŸ¥è¯¢ä½™é¢ | `æŸ¥` / `æŸ¥è¯¢` / `ä½™é¢` | handleQueryBalance |
| æ’è¡Œæ¦œ | `æ’è¡Œ` / `æ’è¡Œæ¦œ` | handleLeaderboard |
| æµæ°´è®°å½• | `æµæ°´` / `å†å²` / `è®°å½•` | handleBetHistory |
| å–æ¶ˆä¸‹æ³¨ | `å–æ¶ˆ` | handleCancelBet |
| ç«‹å³å¼€å¥– | `å¼€å¥–` / `ç«‹å³å¼€å¥–` | executeDraw |
| å¼€å¥–å†å² | `å¼€å¥–å†å²` | handleDrawHistory |
| ä¸‹æ³¨ | åŒ…å«ä¸‹æ³¨æ ¼å¼ | handleBetMessage |
| æ— æ•ˆè¾“å…¥ | å…¶ä»– | å›å¤"@ç”¨æˆ·å è¾“å…¥æ— æ•ˆ" |

---

## 3. å¤„ç†å‡½æ•°è¯¦ç»†è§„èŒƒ

### 3.1 handleQueryBalanceï¼ˆæŸ¥è¯¢ä½™é¢ï¼‰

**å“åº”æ¶ˆæ¯æ ¼å¼**:
```
@å¼ ä¸‰ ä½™é¢: 1250.00
```

---

### 3.2 handleLeaderboardï¼ˆæ’è¡Œæ¦œï¼‰

**å“åº”æ¶ˆæ¯æ ¼å¼**:
```
ã€æ’è¡Œæ¦œã€‘
1. å¼ ä¸‰ - 1250.00 (+250.00)
2. æå›› - 980.00 (-20.00)
3. ç‹äº” - 850.00 (-150.00)
```

**æ•°æ®è·å–**:
- è·å–ç¾¤å†…æ‰€æœ‰ç”¨æˆ·
- æŒ‰ä½™é¢é™åºæ’åº
- æ˜¾ç¤ºä½™é¢å’Œç›ˆäºï¼ˆåˆå§‹ä½™é¢1000ï¼‰

---

### 3.3 handleBetHistoryï¼ˆæµæ°´è®°å½•ï¼‰

**å“åº”æ¶ˆæ¯æ ¼å¼**:
```
@å¼ ä¸‰
ä»Šæ—¥æµæ°´ï¼š500.00ï¼Œä»Šæ—¥ç›ˆäºï¼š+150.00
```

**ç»Ÿè®¡è§„åˆ™**:
- ä»Šæ—¥æµæ°´ = sum(ä»Šæ—¥æ‰€æœ‰ä¸‹æ³¨é‡‘é¢)
- ä»Šæ—¥ç›ˆäº = sum(ä»Šæ—¥æ‰€æœ‰bet.profit)
- æ—¶é—´èŒƒå›´: å½“å¤©00:00:00 å¼€å§‹

---

### 3.4 handleBetMessageï¼ˆä¸‹æ³¨å¤„ç†ï¼‰

**å¤„ç†æµç¨‹**:

1. **è§£æä¸‹æ³¨æŒ‡ä»¤**
   ```javascript
   const bets = gameLogic.parseBets(content, sender.name);
   ```

2. **éªŒè¯æ¯ä¸ªä¸‹æ³¨**
   - æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿ
   - éªŒè¯ç©æ³•æ˜¯å¦åŒ¹é…æ¸¸æˆç±»å‹ï¼ˆå…­åˆå½©åªæ”¯æŒç‰¹ç ï¼‰
   - æ£€æŸ¥é‡‘é¢ã€å·ç èŒƒå›´

3. **æ‰£é™¤ä½™é¢**
   ```javascript
   totalAmount = sum(bets[].amount)
   user.balance -= totalAmount
   ```

4. **ä¿å­˜ä¸‹æ³¨è®°å½•**
   - å­˜å…¥ bets è¡¨
   - çŠ¶æ€: pending
   - ä¿å­˜å½“å‰æœŸå·

5. **å‘é€ç¡®è®¤æ¶ˆæ¯**
   ```
   ğŸ“ ä¸‹æ³¨æˆåŠŸï¼

   1. ç•ª 3 - 200å…ƒ (èµ”ç‡3.0)
   2. æ­£ 1 - 100å…ƒ (èµ”ç‡2.0)

   æ€»é‡‘é¢: 300å…ƒ
   ä½™é¢: 700.00
   æœŸå·: 20250113001
   ```

**å¤±è´¥å“åº”**:
```
âŒ ä¸‹æ³¨å¤±è´¥: ä½™é¢ä¸è¶³ï¼ˆå½“å‰ä½™é¢: 150.00ï¼Œéœ€è¦: 300.00ï¼‰
```

---

### 3.5 executeDrawï¼ˆå¼€å¥–ï¼‰

**å¤„ç†æµç¨‹**:

1. **è·å–å¼€å¥–æ•°æ®**
   - lucky8: è°ƒç”¨ç¬¬ä¸‰æ–¹APIè·å–æ¾³æ´²å¹¸è¿8å¼€å¥–å·ç 
   - liuhecai: è°ƒç”¨ç¬¬ä¸‰æ–¹APIè·å–å…­åˆå½©å¼€å¥–å·ç 

2. **ç»“ç®—æ‰€æœ‰pendingçŠ¶æ€çš„æŠ•æ³¨**
   ```javascript
   for (bet in pending_bets) {
     result = calculate_result(bet, draw_number, special_number)
     bet.status = result.status  // 'win' / 'lose' / 'tie'
     bet.payout = result.payout
     bet.profit = result.profit

     // æ›´æ–°ç”¨æˆ·ä½™é¢
     user.balance += result.payout
   }
   ```

3. **ç”Ÿæˆå¼€å¥–å›¾ç‰‡**
   - è°ƒç”¨ draw-image.js é€»è¾‘ç”Ÿæˆå›¾ç‰‡
   - ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶

4. **å‘é€å¼€å¥–æ¶ˆæ¯**
   ```
   ğŸ‰ã€ç¬¬20250113001æœŸå¼€å¥–ã€‘ğŸ‰

   å¼€å¥–å·ç : 3
   ç‰¹ç : 15

   ä¸­å¥–ç”¨æˆ·ï¼š
   â€¢ å¼ ä¸‰ - ç•ª3 èµ¢ +600.00
   â€¢ æå›› - æ­£1 å’Œ +0.00

   æœªä¸­å¥–ç”¨æˆ·ï¼š
   â€¢ ç‹äº” - æ­£2 è¾“ -100.00
   ```

5. **å‘é€å¼€å¥–å›¾ç‰‡**
   - ä½¿ç”¨æ‚¦èŠBot APIå‘é€å›¾ç‰‡

---

### 3.6 handleDrawHistoryï¼ˆå¼€å¥–å†å²ï¼‰

**å¤„ç†æµç¨‹**:
1. è·å–æœ€è¿‘15æœŸå¼€å¥–è®°å½•
2. åˆå¹¶æœ¬åœ°æ•°æ®å’Œç¬¬ä¸‰æ–¹APIæ•°æ®
3. ç”Ÿæˆå¼€å¥–å†å²å›¾ç‰‡
4. å‘é€å›¾ç‰‡åˆ°ç¾¤èŠ

---

### 3.7 handleCancelBetï¼ˆå–æ¶ˆä¸‹æ³¨ï¼‰

**å¤„ç†æµç¨‹**:
1. è·å–å½“å‰æœŸå·æ‰€æœ‰pendingçŠ¶æ€çš„æŠ•æ³¨
2. é€€è¿˜æœ¬é‡‘
3. åˆ é™¤æŠ•æ³¨è®°å½•
4. å‘é€ç¡®è®¤æ¶ˆæ¯

**å“åº”æ¶ˆæ¯**:
```
âœ… å·²å–æ¶ˆæœ¬æœŸæ‰€æœ‰ä¸‹æ³¨ï¼Œé€€è¿˜é‡‘é¢: 300.00
å½“å‰ä½™é¢: 1000.00
```

---

## 4. POST /api/sync-gametype

### è¯·æ±‚æ ¼å¼
```json
{
  "chatId": "chat_123",
  "gameType": "liuhecai",
  "oldGameType": "lucky8"
}
```

### å“åº”æ ¼å¼
```json
{
  "success": true,
  "message": "æ¸¸æˆå½©ç§å·²åŒæ­¥"
}
```

### å¤„ç†é€»è¾‘
1. æ›´æ–°æ¸¸æˆä¼šè¯çš„gameType
2. æ›´æ–°å¼€å¥–é—´éš”ï¼ˆlucky8: 5åˆ†é’Ÿï¼Œliuhecai: 1å¤©ï¼‰
3. åœæ­¢æ—§å®šæ—¶å™¨
4. å¯åŠ¨æ–°å®šæ—¶å™¨

---

## 5. æ‚¦èŠBot APIè°ƒç”¨

### 5.1 å‘é€æ¶ˆæ¯
```http
POST {BOT_API_BASE}/api/bot/message/{chatId}
Authorization: Bearer {BOT_API_KEY}
X-Bot-Secret: {BOT_API_SECRET}

{
  "content": "æ¶ˆæ¯å†…å®¹"
}
```

### 5.2 å‘é€å›¾ç‰‡
```http
POST {BOT_API_BASE}/api/bot/message/{chatId}/image
Authorization: Bearer {BOT_API_KEY}
X-Bot-Secret: {BOT_API_SECRET}

FormData:
  - file: å›¾ç‰‡æ–‡ä»¶
  - filename: æ–‡ä»¶å
```

### 5.3 åŠ å…¥ç¾¤èŠ
```http
POST {BOT_API_BASE}/api/bot/join/{chatId}
Authorization: Bearer {BOT_API_KEY}
X-Bot-Secret: {BOT_API_SECRET}
```

### 5.4 åŒæ­¥ç¾¤èŠæˆå‘˜
```http
GET {BOT_API_BASE}/api/bot/chat/{chatId}/members
Authorization: Bearer {BOT_API_KEY}
X-Bot-Secret: {BOT_API_SECRET}
```

---

## 6. å…³é”®æ•°æ®ç»“æ„

### ç”¨æˆ·ï¼ˆUserï¼‰
```python
{
  "id": str,           # ç”¨æˆ·ID
  "username": str,     # ç”¨æˆ·å
  "chat_id": str,      # ç¾¤èŠID
  "balance": Decimal,  # ä½™é¢
  "score": int,        # ç§¯åˆ†
  "rebate_ratio": Decimal,  # å›æ°´æ¯”ä¾‹
  "status": str,       # çŠ¶æ€ï¼šæ´»è·ƒ/ç¦ç”¨
  "role": str          # è§’è‰²ï¼šplayer/distributor
}
```

### æŠ•æ³¨ï¼ˆBetï¼‰
```python
{
  "id": UUID,
  "user_id": str,
  "chat_id": str,
  "bet_type": str,     # fan/zheng/nian/jiao/tong/zheng_jin/zhong/odd/even/tema
  "amount": Decimal,
  "odds": Decimal,
  "status": str,       # pending/win/lose/tie/cancelled
  "draw_issue": str,   # æœŸå·
  "draw_number": int,  # å¼€å¥–ç•ªæ•°ï¼ˆ1-4ï¼‰
  "draw_code": str,    # å®Œæ•´å¼€å¥–å·ç 
  "payout": Decimal,   # æ´¾å½©é‡‘é¢
  "profit": Decimal,   # ç›ˆäº
  "bet_details": dict  # æŠ•æ³¨è¯¦æƒ…ï¼ˆJSONï¼‰
}
```

### å¼€å¥–ï¼ˆDrawï¼‰
```python
{
  "id": UUID,
  "chat_id": str,
  "game_type": str,    # lucky8/liuhecai
  "issue": str,        # æœŸå·
  "draw_number": int,  # ç•ªæ•°ï¼ˆ1-4ï¼‰
  "draw_code": str,    # å®Œæ•´å¼€å¥–å·ç 
  "special_number": int,  # ç‰¹ç ï¼ˆ1-49ï¼‰
  "draw_time": datetime
}
```

---

## 7. å¼€å¥–å®šæ—¶å™¨è§„åˆ™

### æ¾³æ´²å¹¸è¿8ï¼ˆlucky8ï¼‰
- é—´éš”: 5åˆ†é’Ÿï¼ˆ300000msï¼‰
- æœŸå·æ ¼å¼: YYYYMMDD + ä¸‰ä½åºå·ï¼ˆå¦‚ï¼š20250113001ï¼‰
- å¼€å¥–å·ç : ä»ç¬¬ä¸‰æ–¹APIè·å–

### å…­åˆå½©ï¼ˆliuhecaiï¼‰
- é—´éš”: 1å¤©ï¼ˆ86400000msï¼‰
- æœŸå·æ ¼å¼: YYYYMMDD
- å¼€å¥–å·ç : ä»ç¬¬ä¸‰æ–¹APIè·å–

---

## 8. å…¼å®¹æ€§æ£€æŸ¥æ¸…å•

- [ ] Webhookè¯·æ±‚/å“åº”æ ¼å¼å®Œå…¨ä¸€è‡´
- [ ] æ‰€æœ‰æ¶ˆæ¯æŒ‡ä»¤å¤„ç†é€»è¾‘ä¸€è‡´
- [ ] ç”¨æˆ·ä½™é¢è®¡ç®—é€»è¾‘ä¸€è‡´
- [ ] ä¸‹æ³¨éªŒè¯è§„åˆ™ä¸€è‡´
- [ ] å¼€å¥–ç»“ç®—è§„åˆ™ä¸€è‡´
- [ ] æ¶ˆæ¯å›å¤æ ¼å¼å®Œå…¨ä¸€è‡´ï¼ˆåŒ…æ‹¬emojiã€æ¢è¡Œã€ç©ºæ ¼ï¼‰
- [ ] æ‚¦èŠBot APIè°ƒç”¨æ ¼å¼ä¸€è‡´
- [ ] å›¾ç‰‡ç”Ÿæˆå’Œå‘é€é€»è¾‘ä¸€è‡´
- [ ] å®šæ—¶å™¨å¯åŠ¨/åœæ­¢é€»è¾‘ä¸€è‡´
- [ ] ç¾¤èŠ/ç”¨æˆ·åˆ›å»ºé€»è¾‘ä¸€è‡´

---

## 9. é”™è¯¯å¤„ç†

### é€šç”¨é”™è¯¯å“åº”
```json
{
  "status": "error",
  "error": "å…·ä½“é”™è¯¯ä¿¡æ¯"
}
```

### HTTPçŠ¶æ€ç 
- 200: æˆåŠŸ
- 500: æœåŠ¡å™¨é”™è¯¯

### æ—¥å¿—è®°å½•
æ‰€æœ‰é”™è¯¯å¿…é¡»è®°å½•åˆ°æ—¥å¿—ï¼ŒåŒ…æ‹¬ï¼š
- é”™è¯¯å †æ ˆ
- è¯·æ±‚æ•°æ®
- å¤„ç†ä¸Šä¸‹æ–‡
